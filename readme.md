## 개발자용 요구사항 (Developer Specifications)

### 1. 개요
카카오톡 형태의 채팅 UI를 가진 웹 애플리케이션으로, 사용자의 `[업체명] [제품명] [갯수]` 형식 입력을 받아 Google Sheet에 저장 및 관리합니다. 사용자 역할(멤버/관리자) 기반의 권한 제어와 실시간 데이터 동기화를 제공합니다.

### 2. 핵심 기능

#### 2.1. 사용자 인증 및 권한 관리 (OAuth 2.0, RBAC)
*   **Google OAuth 2.0 기반 로그인**: 사용자 구글 계정으로 로그인 및 `user_id` 획득.
*   **역할 부여 정책**:
    *   기본값은 `멤버`.
    *   `INITIAL_ADMIN_EMAIL`(제작자 이메일)과 로그인 이메일이 일치하면 최초 로그인 시 임시 `관리자` 권한 부여.
    *   이후 역할 변경은 `관리자`만 가능.
*   **권한**:
    *   **멤버**: 자신이 입력한 데이터만 조회, 수정, 삭제 가능.
    *   **관리자**: 모든 데이터 조회, 수정, 삭제 및 사용자 역할 변경 가능.

#### 2.2. 데이터 입력 및 유효성 검사 (Validation)
*   **입력 UI**: 채팅 메시지 입력창 형태.
*   **입력 형식**: `업체명 제품명 갯수 [제품명 갯수]...` (예: `ABC 제품A 10 제품B 20`)
*   **데이터 파싱**: 입력된 문자열을 `(업체명, 제품명, 갯수)` 쌍으로 파싱.
*   **업체명 정규화**:
    *   입력 즉시 선행/후행 공백 제거(trim).
    *   Google Sheet 시트명 금지문자(`[`, `]`, `:`, `*`, `?`, `/`, `\`) 차단.
    *   최대 30자 제한.
    *   영문 알파벳은 대문자로 통일하여 저장 및 시트명 생성에 사용.
*   **입력 규칙**:
    *   **전체 형식**: `업체명 제품명 갯수` 형태가 아닐 경우: `데이터 입력이 불가능한 형식입니다` 메시지 출력 후 입력 거부.
    *   **공백 처리**: 입력된 모든 값 (업체명, 제품명, 갯수)에서 선행/후행 공백 자동 제거 (trim).
    *   **업체명**: 공백을 포함할 수 없고, 최대 30자까지 허용되며 정규화 결과(대문자 통일)를 기준으로 처리.
    *   **시트명 안전성**: 업체명에 시트명 금지문자(`[`, `]`, `:`, `*`, `?`, `/`, `\`) 포함 시 입력 거부.
    *   **갯수**: 정수만 허용. 소수 또는 숫자가 아닌 값 입력 시: `갯수는 숫자만 입력해주세요.` 메시지 출력 후 입력 거부.
*   **중복 제출 방지(멱등성)**:
    *   클라이언트는 입력 요청마다 `request_id(UUID)`를 생성해 전송.
    *   서버는 이미 처리한 `request_id`를 거부하여 동일 입력의 이중 저장을 방지.
    *   `request_id` 미전송 요청은 `VALIDATION_ERROR`로 즉시 거부.
*   **메시지 표시**: 최신 메시지는 채팅창 하단에, 이전 메시지는 위로 쌓이는 방식으로 표시.

#### 2.3. Google Sheet 연동 및 관리 (Google Sheet API, UUID)
*   **인증/권한 분리 아키텍처**:
    *   사용자 `Google OAuth`는 로그인/신원 확인 용도로만 사용.
    *   Google Sheet 읽기/쓰기/수정/삭제는 앱 전용 `Service Account`로만 수행.
    *   운영 스프레드시트는 단일 관리 대상(`SPREADSHEET_ID`)으로 고정.
*   **Sheet 구조**:
    *   `TEMPLATE` 시트 (시트 인덱스 0): 헤더 및 서식 템플릿으로 사용. (예: 색상, 셀 너비)
    *   `MASTER` 시트 (시트 인덱스 1): 모든 입력 데이터 저장.
    *   `[업체명]` 시트: 각 고유 `업체명`에 대해 자동으로 생성되는 시트. `TEMPLATE` 시트의 헤더와 서식 복사.
*   **컬럼 구조**: 모든 시트는 다음 컬럼을 포함해야 함:
    *   `record_id` (UUID): 각 행의 고유 식별자 (필수)
    *   `입력날짜` (Timestamp, UTC): 데이터가 웹 앱에서 처음 입력된 시간(UTC 고정 저장).
    *   `담당자` (user_id): 데이터를 입력한 사용자의 고유 ID.
    *   `업체명`
    *   `제품명`
    *   `갯수`
*   **데이터 저장**: 입력된 데이터는 `MASTER` 시트와 해당 `[업체명]` 시트에 각각 새로운 행으로 추가.
*   **데이터 수정/삭제**: 웹 앱에서 수정/삭제 시 `record_id`를 사용하여 Google Sheet의 해당 행을 찾아 수정 또는 삭제. (기존 내용 덮어쓰기/삭제 후 재입력).
*   **동기화/실패 정책**:
    *   웹 앱의 데이터 변경사항은 1초 이내에 Google Sheet에 반영되어야 함.
    *   1초 내 반영 실패 시 즉시 실패 처리(로컬 저장/지연 큐 적재 없음).
*   **두 시트 동시 반영 원칙(원자성)**:
    *   성공 조건은 `MASTER`와 `[업체명]` 시트 모두 반영 완료.
    *   한쪽만 반영되면 즉시 실패 처리 후 보정(성공분 롤백 또는 재시도 정합화) 수행.
*   **record_id 탐색 성능 전략**:
    *   로컬 인덱스 테이블(`record_id -> 시트명/행번호`)을 기본 조회 경로로 사용.
    *   인덱스 불일치 시 `record_id` 재탐색 후 인덱스 갱신.

#### 2.4. UI/UX
*   **반응형 디자인**: 모바일 및 데스크탑 환경에서 자연스러운 화면 배치 및 동작.
*   **시간 표시 기준**: 사용자 화면의 시간 표시는 UTC 그대로 사용.
*   **알림 메시지**:
    *   멤버가 자신의 글 수정 성공 시: '수정되었습니다!' 팝업 메시지.
    *   `갯수` 입력 오류 시: '갯수는 숫자만 입력해주세요.' 메시지.
    *   전체 입력 형식 오류 시: '데이터 입력이 불가능한 형식입니다' 메시지.
    *   Google Sheet 반영 실패 시: '[데이터 입력 실패]' 팝업 + 하단에 실패 사유 표시.

### 3. 데이터 모델 (예시)

**Spreadsheet Row (Google Sheet)**:
`[record_id(UUID), 입력날짜(UTC: YYYY-MM-DD HH:MM:SS), 담당자(user_id), 업체명, 제품명, 갯수]`

### 4. 엣지 케이스 및 오류 처리
*   **Google Sheet API 제한**: API 호출 빈도 제한 초과 시 즉시 실패 처리하고 `[데이터 입력 실패]` 팝업과 실패 사유를 표시.
*   **네트워크 오류**: Google Sheet 연동 중 네트워크 오류 발생 시 즉시 실패 처리하고, 데이터는 저장하지 않음.
*   **동일 업체명 시트 존재**: `[업체명]` 시트 생성 시, 이미 존재하는 경우 새로 생성하지 않고 기존 시트 사용.
*   **`TEMPLATE` 시트 누락/손상**: `TEMPLATE` 시트가 없거나 형식이 잘못된 경우, 기본 헤더 및 서식으로 대체하거나 관리자에게 알림.
*   **동시 수정**: 여러 사용자가 동시에 같은 데이터를 수정할 경우, 서버 수신시각 기준 `Last-Write-Wins`로 최종 반영.
*   **행번호 변동(삭제/삽입)**: 인덱스 테이블 행번호가 어긋난 경우 `record_id` 재탐색 후 인덱스를 자동 보정.
*   **오류 메시지 노출 정책**: 사용자에게는 원본 예외 전문 대신 사용자 친화적 사유(권한 부족, 네트워크 장애, API 제한 등)를 표시.
*   **오류코드 표준화**: 내부 오류코드(`SHEET_TIMEOUT`, `SHEET_RATE_LIMIT`, `SHEET_NETWORK_ERROR`, `SHEET_PERMISSION_DENIED`, `VALIDATION_ERROR`)를 정의하고 사용자 메시지와 1:1 매핑.

### 5. 테스트 케이스 (예시)
*   **T1: 유효한 입력**: `ABC 제품1 10` -> MASTER 및 ABC 시트에 정확히 저장되는지 확인.
*   **T2: 다중 제품 입력**: `XYZ 제품A 5 제품B 15` -> MASTER 및 XYZ 시트에 두 개의 개별 행으로 저장되는지 확인.
*   **T3: 갯수 오류 (문자)**: `ABC 제품1 열개` -> `갯수는 숫자만 입력해주세요.` 메시지 및 데이터 미저장 확인.
*   **T4: 갯수 오류 (소수)**: `ABC 제품1 10.5` -> `갯수는 숫자만 입력해주세요.` 메시지 및 데이터 미저장 확인.
*   **T5: 업체명 공백**: `AB C 제품1 10` -> `데이터 입력이 불가능한 형식입니다` 메시지 및 데이터 미저장 확인.
*   **T6: 형식 오류**: `ABC 제품1` (갯수 누락) -> `데이터 입력이 불가능한 형식입니다` 메시지 및 데이터 미저장 확인.
*   **T7: 공백 제거**: ` ABC  제품1   10 ` -> `ABC 제품1 10`으로 정규화되어 저장되는지 확인.
*   **T8: 새 업체 시트 생성**: 이전에 없던 `DEF` 업체 입력 시, `DEF` 시트가 `TEMPLATE` 기반으로 생성되고 데이터가 저장되는지 확인.
*   **T9: 멤버 수정 권한**: 멤버 A가 자신의 데이터만 수정할 수 있고, 다른 멤버 B의 데이터는 수정할 수 없는지 확인.
*   **T10: 관리자 수정 권한**: 관리자가 모든 멤버의 데이터를 수정할 수 있는지 확인.
*   **T11: 데이터 삭제**: 웹 앱에서 데이터 삭제 시, Google Sheet에서도 해당 행이 정확히 삭제되는지 확인.
*   **T12: 동기화 지연**: 웹 앱에서 데이터 수정 후 1초 이내에 Google Sheet에 반영되는지 확인.
*   **T13: 반응형 UI**: 모바일/데스크탑 화면에서 UI 요소들이 깨지지 않고 자연스럽게 표시되는지 확인.
*   **T14: 최초 관리자 부여**: `INITIAL_ADMIN_EMAIL`과 일치하는 계정 로그인 시 관리자 권한이 부여되는지 확인.
*   **T15: 업체명 길이 제한**: 업체명이 31자 이상일 때 입력이 거부되는지 확인.
*   **T16: 시트명 금지문자 차단**: 업체명에 `[ ] : * ? / \` 포함 시 입력이 거부되는지 확인.
*   **T17: 시트 반영 실패 처리**: Google Sheet 오류 시 `[데이터 입력 실패]` 팝업과 실패 사유가 노출되고 데이터가 저장되지 않는지 확인.
*   **T18: 업체명 대문자 정규화**: `abc 제품1 10` 입력 시 업체명이 `ABC`로 저장/시트 생성되는지 확인.
*   **T19: 입력날짜 UTC 저장**: 저장된 `입력날짜`가 UTC 기준 형식으로 기록되는지 확인.
*   **T20: request_id 멱등성**: 동일 `request_id` 재전송 시 중복 저장이 발생하지 않는지 확인.
*   **T21: 두 시트 원자성**: `MASTER` 또는 `[업체명]` 한쪽 실패 시 전체 실패 및 보정이 수행되는지 확인.
*   **T22: 인덱스 불일치 복구**: 인덱스 행번호 불일치 시 `record_id` 재탐색/갱신 후 수정/삭제가 정상 동작하는지 확인.
*   **T23: 동시수정 LWW(서버시각)**: 동시 수정 요청에서 서버 수신시각이 최신인 요청이 최종 반영되는지 확인.
*   **T24: 오류코드 매핑**: 내부 오류코드별 사용자 메시지가 의도대로 노출되는지 확인.
*   **T25: UTC 화면 표시**: 사용자 화면의 시간 표시가 UTC 기준으로 노출되는지 확인.

### 6. SLA (서비스 수준 합의)
*   **처리 모델**: 엄격 동기식(Strong Sync). Google Sheet 반영 성공 시에만 요청 성공 처리.
*   **응답 시간 목표**: 쓰기/수정/삭제 성공 요청의 `P95 <= 1초`.
*   **실패 기준**: 1초 이내 반영되지 않으면 실패로 처리하고 `[데이터 입력 실패]`를 즉시 표시.
*   **가용성 목표(쓰기 성공률)**: 월간 99.5% 이상.
*   **데이터 일관성 원칙**: 실패한 요청은 저장하지 않음(부분 성공/지연 반영 없음).

### 7. 운영 권장 사항 (초기 구현과 병행)
*   **환경 분리**: `dev/stg/prod`별 `SPREADSHEET_ID`와 OAuth 설정을 분리.
*   **비밀키 운영**: Service Account 키는 저장소 커밋 금지, 비밀관리 시스템에 저장하고 정기 교체.
*   **관측성**: 요청 성공률, 지연시간(P95), 실패코드 분포를 로그/대시보드로 수집.
*   **테스트 계층 분리**: 단위/통합(모킹) 테스트와 실제 Google 연동 테스트를 분리 운영.
